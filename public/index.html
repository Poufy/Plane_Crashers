<!DOCTYPE html>
<html lang="">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plane Crashers</title>

  <div style="float: right;">
      <div id="chat-text" style="width: 500px;height:350px;overflow-y:scroll;border:1px solid black;margin-bottom:4px;">
          <div>
            <strong> Welcome to Plane Crashers!</strong>
          </div>
      </div>
      <div id="form">
          <form id="chat-form">
            <!-- reduce size of input space to 400 and add a button -->
            <input id="chat-input" type="text" style="width: 500px;margin-bottom:4px;"></input>
          </form>
      </div>
      <div id="connected-players" style="width: 500px;height:250px  ;overflow-y:scroll;"></div>
  </div>

  <div>
    <canvas id="ctx" width="820" height="600"></canvas>
  </div>

  <script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>
  <script>
      var chatText = document.getElementById('chat-text');
      var chatInput = document.getElementById('chat-input');
      var chatForm = document.getElementById('chat-form');
      var connectedPlayers = document.getElementById('connected-players');

      var ctx = document.getElementById("ctx").getContext("2d");
      ctx.font = '30px Arial';
      var socket = io();
      //setting default values so game does not bug out by sending null mouseX and mouseY values when cursor is initially off the canvas.
      var mouseX = 0;
      var mouseY = 0;


      /*Handling the chat*/
      chatForm.onsubmit = function(event){
        event.preventDefault(); //prevent the browser from refreshing.
        socket.emit('messageToServer' , chatInput.value);
        chatInput.value = '';
      }

      socket.on('messageToClients', function(data){
        chatText.innerHTML += '<div>' + data + '</div>';
      });

      //appending player userName
      socket.on('newPlayer', function(data){
        connectedPlayers.innerHTML = 'Connected Players';
        for(var id in data){
          connectedPlayers.innerHTML += '<div>id: ' + id + '</div>'
        }
            });



  //emiting the mouse Coordinates to the server to calculate the angle there.
      document.addEventListener("mousemove", function(event){
        mouseX = event.clientX;
        mouseY = event.clientY;
      });



      socket.on('newPosition', function(data){
        //clearing the screen
        ctx.fillStyle = "#000000"
        ctx.fillRect(0,0,820,600);
        socket.emit('mouseCoordinates', {mouseX: mouseX, mouseY: mouseY});
        for(var i in data.ships){

           //drawing the ships
           ctx.save();
           ctx.translate(data.ships[i].x, data.ships[i].y);
           console.log(data.ships[i]);
           ctx.rotate(data.ships[i].angle);
           ctx.fillStyle = "#00FF00"
           ctx.fillRect(10, 10,30,30);
           ctx.restore();

           //drawing the bullets
           for(var k in data.ships[i].bullets){
             ctx.save();
             ctx.translate(data.ships[i].bullets[k].x,data.ships[i].bullets[k].y);
             ctx.rotate(data.ships[i].bullets[k].angle);
             ctx.fillStyle = "#1ABC9C"
             ctx.fillRect(10, 10,10,10);
             ctx.restore();

           }

}

});
      /*Handling the key presses*/

      document.onkeydown = function(event){
        if(event.keyCode === 87)
          socket.emit('thrust', true);
      }

      document.onmousedown = function(event){
        socket.emit('fire');
      }
      document.onkeyup = function(event){
        if(event.keyCode === 87)
          socket.emit('thrust', false);
      }
  </script>
  </head>
  </html>
